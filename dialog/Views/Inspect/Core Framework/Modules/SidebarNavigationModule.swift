//
//  SidebarNavigationModule.swift
//  dialog
//
//  Created by Henry Stamerjohann, Declarative IT GmbH, 25/01/2026
//
//  Reusable sidebar navigation module for step-based workflows.
//  Provides a modern vertical stepper with clean Preset11-style aesthetics.
//
//  Used by: Preset6 (modern sidebar variant)
//

import SwiftUI

// MARK: - Sidebar Navigation Module

/// A reusable sidebar navigation component for step-based workflows.
/// Displays a vertical list of steps with progress indicators and selection support.
struct SidebarNavigationModule: View {
    let items: [InspectConfig.ItemConfig]
    let currentStep: Int
    let completedSteps: Set<String>
    let downloadingSteps: Set<String>
    let accentColor: Color
    let logoPath: String?
    let title: String?
    let showStepNumbers: Bool
    let showCompletionMarks: Bool
    let width: CGFloat
    let scaleFactor: CGFloat
    let onStepSelected: (Int) -> Void
    let isNavigationBlocked: Bool

    init(
        items: [InspectConfig.ItemConfig],
        currentStep: Int,
        completedSteps: Set<String>,
        downloadingSteps: Set<String> = [],
        accentColor: Color = .blue,
        logoPath: String? = nil,
        title: String? = nil,
        showStepNumbers: Bool = true,
        showCompletionMarks: Bool = true,
        width: CGFloat = 220,
        scaleFactor: CGFloat = 1.0,
        onStepSelected: @escaping (Int) -> Void,
        isNavigationBlocked: Bool = false
    ) {
        self.items = items
        self.currentStep = currentStep
        self.completedSteps = completedSteps
        self.downloadingSteps = downloadingSteps
        self.accentColor = accentColor
        self.logoPath = logoPath
        self.title = title
        self.showStepNumbers = showStepNumbers
        self.showCompletionMarks = showCompletionMarks
        self.width = width
        self.scaleFactor = scaleFactor
        self.onStepSelected = onStepSelected
        self.isNavigationBlocked = isNavigationBlocked
    }

    /// Filter to display only non-intro/outro steps in sidebar
    private var displayItems: [(index: Int, item: InspectConfig.ItemConfig)] {
        items.enumerated().filter { _, item in
            item.stepType != "intro" && item.stepType != "outro"
        }.map { ($0.offset, $0.element) }
    }

    var body: some View {
        VStack(spacing: 0) {
            // Header with logo and title
            headerSection
                .padding(.top, 16 * scaleFactor)
                .padding(.bottom, 12 * scaleFactor)

            Divider()
                .padding(.horizontal, 16 * scaleFactor)

            // Step list
            ScrollViewReader { proxy in
                ScrollView(.vertical, showsIndicators: false) {
                    LazyVStack(spacing: 4 * scaleFactor) {
                        ForEach(displayItems, id: \.index) { displayIndex, item in
                            let actualIndex = displayIndex
                            ModernStepRow(
                                index: displayIndex,
                                item: item,
                                isActive: actualIndex == currentStep,
                                isCompleted: completedSteps.contains(item.id),
                                isDownloading: downloadingSteps.contains(item.id),
                                accentColor: accentColor,
                                showStepNumber: showStepNumbers,
                                showCompletionMark: showCompletionMarks,
                                scaleFactor: scaleFactor,
                                isNavigationBlocked: isNavigationBlocked
                            )
                            .id("step_\(actualIndex)")
                            .onTapGesture {
                                if !isNavigationBlocked {
                                    onStepSelected(actualIndex)
                                }
                            }
                        }
                    }
                    .padding(.vertical, 8 * scaleFactor)
                    .padding(.horizontal, 12 * scaleFactor)
                }
                .onChange(of: currentStep) { _, newStep in
                    withAnimation(.easeInOut(duration: 0.3)) {
                        proxy.scrollTo("step_\(newStep)", anchor: .center)
                    }
                }
            }

            Spacer(minLength: 0)

            // Bottom logo section (optional)
            if let logoPath = logoPath {
                bottomLogoSection(logoPath: logoPath)
            }
        }
        .frame(width: width * scaleFactor)
        .background(
            Color(NSColor.controlBackgroundColor)
                .opacity(0.5)
        )
    }

    // MARK: - Header Section

    @ViewBuilder
    private var headerSection: some View {
        VStack(spacing: 8 * scaleFactor) {
            // Title
            if let title = title, !title.isEmpty {
                Text(title)
                    .font(.system(size: 14 * scaleFactor, weight: .semibold))
                    .foregroundStyle(.primary)
                    .lineLimit(2)
                    .multilineTextAlignment(.center)
            }

            // Progress indicator
            progressIndicator
        }
        .padding(.horizontal, 16 * scaleFactor)
    }

    @ViewBuilder
    private var progressIndicator: some View {
        let totalRealSteps = displayItems.count
        let completedCount = displayItems.filter { completedSteps.contains($0.item.id) }.count
        let progress = totalRealSteps > 0 ? Double(completedCount) / Double(totalRealSteps) : 0

        VStack(spacing: 4 * scaleFactor) {
            // Progress bar
            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    RoundedRectangle(cornerRadius: 2)
                        .fill(accentColor.opacity(0.2))
                        .frame(height: 4 * scaleFactor)

                    RoundedRectangle(cornerRadius: 2)
                        .fill(accentColor)
                        .frame(width: geometry.size.width * progress, height: 4 * scaleFactor)
                        .animation(.easeInOut(duration: 0.3), value: progress)
                }
            }
            .frame(height: 4 * scaleFactor)

            // Step counter text
            Text("\(completedCount) of \(totalRealSteps) completed")
                .font(.system(size: 11 * scaleFactor))
                .foregroundStyle(.secondary)
                .monospacedDigit()
        }
    }

    // MARK: - Bottom Logo Section

    @ViewBuilder
    private func bottomLogoSection(logoPath: String) -> some View {
        Divider()
            .padding(.horizontal, 16 * scaleFactor)

        if let nsImage = NSImage(contentsOfFile: logoPath) {
            Image(nsImage: nsImage)
                .resizable()
                .aspectRatio(contentMode: .fit)
                .frame(maxWidth: 100 * scaleFactor, maxHeight: 32 * scaleFactor)
                .padding(.vertical, 12 * scaleFactor)
                .padding(.horizontal, 16 * scaleFactor)
        }
    }
}

// MARK: - Modern Step Row

/// A single step row in the sidebar navigation.
/// Clean, minimal design matching Preset11's aesthetics.
struct ModernStepRow: View {
    let index: Int
    let item: InspectConfig.ItemConfig
    let isActive: Bool
    let isCompleted: Bool
    let isDownloading: Bool
    let accentColor: Color
    let showStepNumber: Bool
    let showCompletionMark: Bool
    let scaleFactor: CGFloat
    let isNavigationBlocked: Bool

    /// Get step number for display (1-indexed, excluding intro steps)
    private var displayStepNumber: Int {
        // The index is already filtered to exclude intro/outro, so just add 1 for 1-indexed display
        return index + 1
    }

    var body: some View {
        HStack(spacing: 12 * scaleFactor) {
            // Step indicator (number, checkmark, or spinner)
            stepIndicator
                .frame(width: 28 * scaleFactor, height: 28 * scaleFactor)

            // Step content
            VStack(alignment: .leading, spacing: 2 * scaleFactor) {
                Text(item.displayName)
                    .font(.system(size: 13 * scaleFactor, weight: isActive ? .semibold : .regular))
                    .foregroundStyle(isActive ? .primary : .secondary)
                    .lineLimit(1)

                // Optional subtitle (status or description)
                if let subtitle = stepSubtitle {
                    Text(subtitle)
                        .font(.system(size: 11 * scaleFactor))
                        .foregroundStyle(subtitleColor)
                        .lineLimit(1)
                }
            }

            Spacer(minLength: 0)
        }
        .padding(.horizontal, 12 * scaleFactor)
        .padding(.vertical, 8 * scaleFactor)
        .background(
            RoundedRectangle(cornerRadius: 8 * scaleFactor)
                .fill(isActive ? accentColor.opacity(0.12) : Color.clear)
        )
        .overlay(
            RoundedRectangle(cornerRadius: 8 * scaleFactor)
                .strokeBorder(isActive ? accentColor.opacity(0.3) : Color.clear, lineWidth: 1)
        )
        .contentShape(Rectangle())
        .opacity(isNavigationBlocked && !isActive ? 0.6 : 1.0)
        .animation(.easeInOut(duration: 0.2), value: isActive)
    }

    // MARK: - Step Indicator

    @ViewBuilder
    private var stepIndicator: some View {
        ZStack {
            if isCompleted && showCompletionMark {
                // Completed state - checkmark
                Circle()
                    .fill(Color.green)
                Image(systemName: "checkmark")
                    .font(.system(size: 12 * scaleFactor, weight: .bold))
                    .foregroundStyle(.white)
            } else if isDownloading {
                // Downloading/processing state - spinner
                Circle()
                    .fill(accentColor.opacity(0.15))
                ProgressView()
                    .scaleEffect(0.6 * scaleFactor)
            } else if isActive {
                // Active state - filled circle with number
                Circle()
                    .fill(accentColor)
                if showStepNumber {
                    Text("\(displayStepNumber)")
                        .font(.system(size: 12 * scaleFactor, weight: .bold))
                        .foregroundStyle(.white)
                }
            } else {
                // Pending state - outlined circle with number
                Circle()
                    .strokeBorder(Color.secondary.opacity(0.3), lineWidth: 1.5)
                if showStepNumber {
                    Text("\(displayStepNumber)")
                        .font(.system(size: 12 * scaleFactor, weight: .medium))
                        .foregroundStyle(.secondary)
                }
            }
        }
    }

    // MARK: - Step Subtitle

    private var stepSubtitle: String? {
        if isCompleted {
            return "Completed"
        } else if isDownloading {
            return "In progress..."
        } else if isActive {
            return "Current step"
        }
        return nil
    }

    private var subtitleColor: Color {
        if isCompleted {
            return .green
        } else if isDownloading {
            return accentColor
        }
        return .secondary
    }
}

// MARK: - Preview

#if DEBUG
struct SidebarNavigationModule_Previews: PreviewProvider {
    static var previews: some View {
        SidebarNavigationModule(
            items: [
                InspectConfig.ItemConfig(id: "step1", title: "Welcome"),
                InspectConfig.ItemConfig(id: "step2", title: "Configure Settings"),
                InspectConfig.ItemConfig(id: "step3", title: "Install Software"),
                InspectConfig.ItemConfig(id: "step4", title: "Complete Setup")
            ],
            currentStep: 1,
            completedSteps: ["step1"],
            accentColor: .blue,
            title: "Setup Assistant",
            onStepSelected: { _ in }
        )
        .frame(height: 400)
        .background(Color(NSColor.windowBackgroundColor))
    }
}
#endif
